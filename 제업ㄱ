    -- ìµœì¢… í†µí•©: getQuestNum ì˜¤ë¥˜ ë¬´ì‹œ + findSlime/findGoblin ë³µêµ¬ + ë¨¸ë¦¬ ìœ„ ìˆ˜ì§ ì—ë“œë¦¼ | ì¿¨íƒ€ì„ 0.02ì´ˆ | anti-macro
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local VirtualInputManager = game:GetService("VirtualInputManager")
local GuiService = game:GetService("GuiService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local Character, HRP, Hum = nil, nil, nil
local farming = true
local lastSell = 0
local curTarget = nil
local switchTime = 0
local AntiMacroEnabled = true  -- ë§¤í¬ë¡œ ìš°íšŒ í™œì„±í™”

-- ë¦¬ìŠ¤í° ë°”ì¸ë“œ
local function bindChar(char)
    print("[DEBUG] ìºë¦­í„° ì¬ë°”ì¸ë“œ")
    Character = char
    HRP = char:WaitForChild("HumanoidRootPart", 10)
    Hum = char:WaitForChild("Humanoid", 10)
    if not HRP or not Hum then task.wait(3) bindChar(char) return end
    
    Hum.MaxHealth = math.huge Hum.Health = math.huge
    for _, p in pairs(char:GetDescendants()) do if p:IsA("BasePart") then p.CanCollide = false end end
    Instance.new("ForceField", char)
end

LocalPlayer.CharacterAdded:Connect(function(c) task.wait(0.5) bindChar(c) end)
if LocalPlayer.Character then bindChar(LocalPlayer.Character) end

-- ë ˆë²¨
local function getLevel()
    local ls = LocalPlayer:WaitForChild("leaderstats", 8)
    if not ls then return 0 end
    local lvl = ls:WaitForChild("Level", 5)
    if not lvl then return 0 end
    return lvl.Value or 0
end

-- getQuestNum ì˜¤ë¥˜ ì™„ì „ ë¬´ì‹œ (pcall ì „ì²´ + ì´ë¦„ ìë™ íƒìƒ‰)
local function getQuestNum()
    local success, result = pcall(function()
        print("[DEBUG] getQuestNum ì‹œë„")
        
        local pg = LocalPlayer:WaitForChild("PlayerGui", 20)
        if not pg then return 0 end
        
        local guiNames = {"ScreenGui", "MainGui", "UI", "Hud", "PlayerHud", "GameUI", "QuestGui", "MissionUI", "TaskFrame", "Overlay", "Interface", "Gui", "MainUI", "PlayerUI", "CoreGui"}
        local sg = nil
        for _, name in ipairs(guiNames) do
            sg = pg:FindFirstChild(name, true)
            if sg then
                print("[DEBUG] ScreenGui ë°œê²¬: " .. name)
                break
            end
        end
        if not sg then return 0 end
        
        local questNames = {"Quest", "QuestFrame", "Mission", "Task", "QuestUI", "Objective", "QuestLog", "Progress", "Quests", "MissionFrame", "TaskUI", "QuestPanel"}
        local q = nil
        for _, name in ipairs(questNames) do
            q = sg:FindFirstChild(name, true)
            if q then
                print("[DEBUG] Quest ë°œê²¬: " .. name)
                break
            end
        end
        if not q then return 0 end
        
        for _, o in pairs(q:GetDescendants()) do
            if o and (o:IsA("TextLabel") or o:IsA("TextButton") or o:IsA("TextBox")) then
                local t = o.Text or ""
                if t:find("%[2%]") then return 2 end
            end
        end
        return 0
    end)
    
    if not success then
        print("[WARNING] getQuestNum ë‚´ë¶€ ì˜¤ë¥˜ â†’ ë¬´ì‹œí•˜ê³  0 ë°˜í™˜")
    end
    
    return success and result or 0
end

-- SellItem
local function trySell()
    if tick() - lastSell < 1.5 then return end
    local r = ReplicatedStorage:FindFirstChild("Remote")
    if not r then return end
    local s = r:FindFirstChild("SellItem")
    if not s then return end
    local args = {"ëŒ ê³¨ë ˜ ë¨¸ë¦¬", "10"}
    pcall(s.FireServer, s, unpack(args))
    lastSell = tick()
end

-- íŠ¹ìˆ˜ ê³ ë¸”ë¦° ìŠ¤í‚µ
local function isSpecial(mob)
    if not mob then return false end
    local la = mob:FindFirstChild("Left Arm") or mob:FindFirstChild("LeftArm")
    if not la then return false end
    local lar = la:FindFirstChild("L Armor") or la:FindFirstChild("LArmor")
    if not lar then return false end
    local m = lar:FindFirstChild("Meshes")
    if not m then return false end
    return m:FindFirstChild("zompg forest mob_Cone") ~= nil
end

-- ìŠ¬ë¼ì„ ì°¾ê¸°
local function findSlime()
    local folder = workspace:FindFirstChild("Mobs")
    if not folder then print("[ERROR] Mobs í´ë” ì—†ìŒ") return nil end
    
    local kids = folder:GetChildren()
    local cands = {}
    
    for _, m in ipairs(kids) do
        if m and m:IsA("Model") and m.Name == "ìŠ¬ë¼ì„" then
            local h = m:FindFirstChild("Humanoid")
            local hrp = m:FindFirstChild("HumanoidRootPart")
            if h and hrp and h.Health > 0 then
                table.insert(cands, m)
            else
                print("[DEBUG] ìŠ¬ë¼ì„ " .. m.Name .. " - Humanoid/HRP nil â†’ ìŠ¤í‚µ")
            end
        end
    end
    
    print("[DEBUG] ìŠ¬ë¼ì„ í›„ë³´: " .. #cands)
    if #cands == 0 then return nil end
    
    table.sort(cands, function(a,b)
        local aHRP = a:FindFirstChild("HumanoidRootPart")
        local bHRP = b:FindFirstChild("HumanoidRootPart")
        if not aHRP or not bHRP then return false end
        return (HRP.Position - aHRP.Position).Magnitude < (HRP.Position - bHRP.Position).Magnitude
    end)
    
    return cands[1]
end

-- ê³ ë¸”ë¦° ì°¾ê¸°
local function findGoblin()
    local folder = workspace:FindFirstChild("Mobs")
    if not folder then print("[ERROR] Mobs í´ë” ì—†ìŒ") return nil end
    
    local kids = folder:GetChildren()
    local cands = {}
    
    for _, m in ipairs(kids) do
        if m and m:IsA("Model") and (m.Name == "ê³ ë¸”ë¦°" or m.Name:find("ê³ ë¸”ë¦°") or m.Name:lower():find("goblin")) then
            local h = m:FindFirstChild("Humanoid")
            local hrp = m:FindFirstChild("HumanoidRootPart")
            if h and hrp and h.Health > 0 and not isSpecial(m) then
                table.insert(cands, m)
            else
                print("[DEBUG] ê³ ë¸”ë¦° " .. m.Name .. " - Humanoid/HRP nil â†’ ìŠ¤í‚µ")
            end
        end
    end
    
    print("[DEBUG] ê³ ë¸”ë¦° í›„ë³´: " .. #cands)
    if #cands == 0 then return nil end
    
    table.sort(cands, function(a,b)
        local aHRP = a:FindFirstChild("HumanoidRootPart")
        local bHRP = b:FindFirstChild("HumanoidRootPart")
        if not aHRP or not bHRP then return false end
        return (HRP.Position - aHRP.Position).Magnitude < (HRP.Position - bHRP.Position).Magnitude
    end)
    
    return cands[1]
end

-- íˆíŠ¸ë°•ìŠ¤ ìë™ ì„ íƒ
local function getBestHitPart(mob)
    if not mob then return HRP end
    for _, name in ipairs({"Head", "UpperTorso", "Torso", "HumanoidRootPart", "LowerTorso"}) do
        local part = mob:FindFirstChild(name)
        if part then return part end
    end
    return mob:FindFirstChild("HumanoidRootPart") or mob
end

-- ê³µê²© (ì¿¨íƒ€ì„ 0.02ì´ˆ)
local function attack()
    local tool = Character:FindFirstChildWhichIsA("Tool")
    if not tool then
        print("[DEBUG] íˆ´ ì—†ìŒ â†’ ê°•ì œ Equip")
        for _, t in pairs(LocalPlayer.Backpack:GetChildren()) do
            if t:IsA("Tool") then
                Hum:EquipTool(t)
                task.wait(0.15)
                tool = Character:FindFirstChildWhichIsA("Tool")
                if tool then print("[DEBUG] íˆ´ ì¥ì°©: " .. tool.Name) break end
            end
        end
    end
    
    if tool then
        print("[ATTACK] ê³µê²© ì‹œì‘ - 0.02ì´ˆ")
        for i = 1, 80 do
            pcall(tool.Activate, tool)
            task.wait(0.02)
        end
    else
        print("[WARNING] íˆ´ ì—†ìŒ")
    end
    
    VirtualUser:Button1Down(Vector2.new(500, 500))
    task.wait(0.02)
    VirtualUser:Button1Up(Vector2.new(500, 500))
end

-- ë§¤í¬ë¡œ ìš°íšŒ (ë„ˆê°€ ì¤€ ì½”ë“œ ê·¸ëŒ€ë¡œ í†µí•©)
local function clickGuiObject(obj)
    if not obj or not obj.Visible or not obj.Active then return end
    
    local pos = obj.AbsolutePosition
    local size = obj.AbsoluteSize
    local topbarInset = GuiService:GetGuiInset().Y
    
    local x = pos.X + (size.X / 2)
    local y = pos.Y + (size.Y / 2) + topbarInset

    VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
    task.wait(0.05)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
end

local function findDigitButton(keyFrame, digit)
    for _, btn in ipairs(keyFrame:GetChildren()) do
        if (btn:IsA("TextButton") or btn:IsA("ImageButton")) and btn.Text == digit then
            return btn
        end
    end
    return nil
end

task.spawn(function()
    while true do
        task.wait(1)
        
        if AntiMacroEnabled then
            pcall(function()
                local player = Players.LocalPlayer
                if not player then return end

                local gui = player.PlayerGui:FindFirstChild("MacroGui")
                if gui and gui.Enabled then
                    local rootFrame = gui:FindFirstChild("Frame") or gui:FindFirstChild("MacroClient") or gui
                    if not rootFrame then return end
                    
                    local displayFrame = rootFrame:FindFirstChild("Frame")
                    local keyFrame = rootFrame:FindFirstChild("KeyInputFrame")
                    local resetFrame = rootFrame:FindFirstChild("KeyReset")
                    
                    if displayFrame and keyFrame then
                        local inputLabel = displayFrame:FindFirstChild("Input") or displayFrame:FindFirstChildWhichIsA("TextLabel")
                        local outputBox = displayFrame:FindFirstChild("TextBox")
                        
                        if inputLabel and outputBox then
                            local targetNum = inputLabel.Text:match("%d%d%d%d")
                            
                            if targetNum and outputBox.Text ~= targetNum then
                                print("[MACRO] ë§¤í¬ë¡œ ê°ì§€ â†’ " .. targetNum .. " ì…ë ¥ ì‹œë„")
                                
                                if not keyFrame.Visible then
                                    clickGuiObject(outputBox)
                                    task.wait(0.8)
                                end
                                
                                local resetBtn = resetFrame and resetFrame:FindFirstChild("TextButton")
                                if resetBtn then
                                    for i = 1, 5 do
                                        if outputBox.Text == "" then break end
                                        clickGuiObject(resetBtn)
                                        task.wait(0.4)
                                    end
                                end
                                
                                task.wait(0.5)
                                
                                if outputBox.Text == "" then
                                    for i = 1, #targetNum do
                                        local digit = string.sub(targetNum, i, i)
                                        local btn = findDigitButton(keyFrame, digit)
                                        
                                        if btn then
                                            clickGuiObject(btn)
                                            task.wait(0.35)
                                        else
                                            warn("ìˆ«ì ë²„íŠ¼ ëª» ì°¾ìŒ: " .. digit)
                                        end
                                    end
                                    print("[MACRO] ì…ë ¥ ì™„ë£Œ: " .. targetNum)
                                end
                                
                                task.wait(2.5)
                            end
                        end
                    end
                end
            end)
        end
    end
end)

-- ë©”ì¸ ë£¨í”„ (ìˆ˜ì§ ë¨¸ë¦¬ ìœ„ ì—ë“œë¦¼ ê³ ì •)
RunService.Heartbeat:Connect(function()
    if not farming or not HRP then return end
    
    local lvl = getLevel()
    if lvl >= 15 then farming = false print("Lv15 â†’ ì¢…ë£Œ") return end
    
    local q = getQuestNum()
    if q == 2 then trySell() end
    
    if not curTarget or not curTarget.Parent or (curTarget:FindFirstChildWhichIsA("Humanoid") and curTarget.Humanoid.Health <= 0) then
        if lvl >= 10 then
            curTarget = findSlime()
        else
            curTarget = findGoblin()
        end
        switchTime = tick()
        if curTarget then print("[TARGET] " .. curTarget.Name) end
    end
    
    if not curTarget then task.wait(1) return end
    
    local head = curTarget:FindFirstChild("Head") or curTarget:FindFirstChild("HumanoidRootPart")
    if not head then
        print("[WARNING] Head/HRP nil â†’ ì¬íƒìƒ‰")
        curTarget = nil
        return
    end
    
    local off = Vector3.new(0, 2.3, -0.3) -- ë¨¸ë¦¬ ìœ„ 2.3 + ì•ìœ¼ë¡œ 0.3
    
    local baseCFrame = CFrame.new(head.Position + off, head.Position)
    local tilt = CFrame.Angles(math.rad(-60), 0, 0) -- ì—ë“œë¦¼ ê°ë„
    
    local finalCFrame = baseCFrame * tilt
    
    local tweenInfo = TweenInfo.new(0.1, Enum.EasingStyle.Linear)
    local goal = {CFrame = finalCFrame}
    local tween = TweenService:Create(HRP, tweenInfo, goal)
    tween:Play()
    
    pcall(function() HRP:SetNetworkOwner(LocalPlayer) end)
    HRP.Velocity = Vector3.new(0,0,0)
    
    Hum.MaxHealth = math.huge Hum.Health = math.huge
    task.spawn(attack)
end)

print("ğŸš€ ìµœì¢… í†µí•© ì‹¤í–‰ | getQuestNum ì˜¤ë¥˜ ë¬´ì‹œ | findSlime/findGoblin ë³µêµ¬ | F9 ë¡œê·¸ í™•ì¸")
    
