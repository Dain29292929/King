-- [[ ì„œë¹„ìŠ¤ ë° ê¸°ë³¸ ë³€ìˆ˜ ì •ì˜ ]]
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- [[ ìºë¦­í„° êµ³ìŒ ë°©ì§€ ]]
if LocalPlayer.Character then
    local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
    if hum then hum.PlatformStand = false end
end

-- [[ ì˜¤í† íŒœ ì„¤ì • í…Œì´ë¸” ]]
local AutoFarmConfig = {
    Enabled = false,
    Distance = -0.3,          -- ì•ìœ¼ë¡œ ì‚´ì§ ê°€ê¹Œì´
    HeightOffset = 2.5,       -- ë¨¸ë¦¬ ìœ„ 2.5 (ë” ê°€ê¹Œì´)
    TargetMob = nil,
    CurrentTarget = nil,
    AutoSkillEnabled = false,
    AutoClickEnabled = true,
    Skills = {E = false, R = false, T = false}
}

local AttackDirection = "Up" -- ìœ„ìª½ ìˆ˜ì§ ê³ ì •
local DirectionAngles = {Front = 0, Back = 180, Up = -90, Down = 90}
local Mobs = Workspace:WaitForChild("Mobs") 
local MobList, MobMap = {}, {} 
local AutoFarmConnection = nil 
local lastAttackTime = 0 
local lastSkillTime = 0 
local LastSpawnTime = 0
local deathPauseUntil = 0  -- ì£½ìŒ í›„ ì¤‘ë‹¨ ì‹œê°„

-- ë¦¬ìŠ¤í° & ì‚¬ë§ ê°ì§€
Players.LocalPlayer.CharacterAdded:Connect(function()
    LastSpawnTime = tick()
end)

-- ì‚¬ë§ ì‹œ 5ì´ˆ ì¤‘ë‹¨
LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(0.5)
    local hum = char:WaitForChild("Humanoid", 5)
    if hum then
        hum.Died:Connect(function()
            print("[DEATH] ì‚¬ë§ â†’ 5ì´ˆ ì˜¤í† íŒœ ì¤‘ë‹¨")
            AutoFarmConfig.Enabled = false
            deathPauseUntil = tick() + 5
            AutoFarmConfig.CurrentTarget = nil
        end)
    end
end)

-- [[ ìºë¦­í„° ê°ì²´ ê°€ì ¸ì˜¤ê¸° ]]
local function getCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

-- [[ ìŠ¤í‚¬ ì‚¬ìš© í•¨ìˆ˜ ]]
local function fireSkill(skillKey)
    pcall(function()
        local remote = ReplicatedStorage:WaitForChild("Remote"):WaitForChild("Skill")
        remote:FireServer(skillKey)
    end)
end

-- [[ ëª¹ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  í•¨ìˆ˜ ]]
local function getMobList()
    local mobsFolder = Workspace:FindFirstChild("Mobs")
    if not mobsFolder then return {}, {} end

    local processedMobs = {}
    local mobDisplayList = {}
    local mobNameMap = {}

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        if mob.Name and mob:FindFirstChild("Humanoid") and mob:FindFirstChild("HumanoidRootPart") then
            if not processedMobs[mob.Name] then
                local displayName = mob.Name 
                table.insert(mobDisplayList, displayName)
                mobNameMap[displayName] = mob.Name
                processedMobs[mob.Name] = true
            end
        end
    end

    table.sort(mobDisplayList)
    return mobDisplayList, mobNameMap
end

-- ì´ˆê¸° ëª¹ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
MobList, MobMap = getMobList()

-- [[ ëª¹ ì‚¬ë§ ì—¬ë¶€ í™•ì¸ ]]
local function isMobDead(mob)
    if not (mob and mob.Parent) then return true end
    
    local humanoid = mob:FindFirstChildOfClass("Humanoid")
    local rootPart = mob:FindFirstChild("HumanoidRootPart") or mob:FindFirstChild("HRP")

    if not rootPart then return true end 
    if humanoid and humanoid.Health <= 0 then return true end 

    return false
end

-- [[ íƒ€ê²Ÿ ëª¹ ì°¾ê¸° ]]
local function findTargetMob()
    if not AutoFarmConfig.TargetMob then return nil end
    
    for _, mob in pairs(Mobs:GetChildren()) do
        if not isMobDead(mob) then
            if mob.Name == AutoFarmConfig.TargetMob or string.find(mob.Name, AutoFarmConfig.TargetMob) then
                return mob
            end
        end
    end
    return nil
end

-- [[ ê³µê²© í•¨ìˆ˜ (ë¬¼ë¦¬ í´ë¦­) ]]
local function attack()
    VirtualUser:Button1Down(Vector2.new(500, 500))
    task.wait(0.055)
    VirtualUser:Button1Up(Vector2.new(500, 500))
end

-- [[ ìœ„ì¹˜ ê³„ì‚° (CFrame) ]]
local function calculatePerfectCFrame(targetPos, distanceOffset, attackDirection)
    local targetRootPart = AutoFarmConfig.CurrentTarget:FindFirstChild("HumanoidRootPart") or AutoFarmConfig.CurrentTarget:FindFirstChild("HRP")
    if not targetRootPart then return CFrame.new(targetPos) end

    local npcLookDirection = targetRootPart.CFrame.LookVector
    local offsetPosition = targetRootPart.Position + (npcLookDirection * distanceOffset)
    offsetPosition = Vector3.new(offsetPosition.X, targetPos.Y, offsetPosition.Z)

    if attackDirection == "Up" or attackDirection == "Down" then
        local angle = DirectionAngles[attackDirection] or 0
        return CFrame.new(offsetPosition) * CFrame.Angles(math.rad(angle), 0, 0)
    else
        return CFrame.lookAt(offsetPosition, targetRootPart.Position)
    end
end

-- [[ ì˜¤í† íŒœ ì‹œì‘ í•¨ìˆ˜ ]]
local function startAutoFarm()
    if AutoFarmConnection then 
        AutoFarmConnection:Disconnect()
        AutoFarmConnection = nil
    end

    local waitCFrame = nil

    AutoFarmConnection = RunService.Heartbeat:Connect(function()
        -- ë¦¬ìŠ¤í° ì§í›„ 3ì´ˆ ì •ì§€
        if tick() - LastSpawnTime < 3 then 
            waitCFrame = nil
            return 
        end

        -- ì£½ìŒ/ì•ˆí‹°ì¹˜íŠ¸ í›„ 5ì´ˆ ì¤‘ë‹¨
        if tick() < deathPauseUntil then
            return
        end

        local character = LocalPlayer.Character
        if not character then return end

        local humanoid = character:FindFirstChildOfClass("Humanoid")
        local hrp = character:FindFirstChild("HumanoidRootPart")
        if not humanoid or not hrp then return end

        if humanoid.Health <= 0 then
            AutoFarmConfig.CurrentTarget = nil
            waitCFrame = nil 
            return
        end

        if not AutoFarmConfig.Enabled then
            humanoid.PlatformStand = false
            waitCFrame = nil
            return
        end

        if AutoFarmConfig.CurrentTarget and isMobDead(AutoFarmConfig.CurrentTarget) then
            AutoFarmConfig.CurrentTarget = nil
        end
        
        if not AutoFarmConfig.CurrentTarget then
            AutoFarmConfig.CurrentTarget = findTargetMob()
        end

        local currentTarget = AutoFarmConfig.CurrentTarget

        if not currentTarget then
            hrp.Velocity = Vector3.new(0, 0, 0)
            
            if not waitCFrame then
                waitCFrame = hrp.CFrame * CFrame.new(0, 10, 0)
            end
            
            hrp.CFrame = waitCFrame 
            return
        else
            waitCFrame = nil
        end

        local targetRootPart = currentTarget:FindFirstChild("HumanoidRootPart") or currentTarget:FindFirstChild("HRP")
        if not targetRootPart then
            AutoFarmConfig.CurrentTarget = nil
            return
        end

        local targetPos = Vector3.new(
            targetRootPart.Position.X,
            targetRootPart.Position.Y + AutoFarmConfig.HeightOffset,
            targetRootPart.Position.Z
        )

        local finalCFrame = calculatePerfectCFrame(targetPos, AutoFarmConfig.Distance, AttackDirection)
        hrp.CFrame = finalCFrame

        -- í”ë“¤ë¦¼ ë°©ì§€
        pcall(function() hrp:SetNetworkOwner(LocalPlayer) end)
        hrp.Velocity = Vector3.new(0,0,0)
        hrp.Anchored = true
        task.wait(0.08)
        hrp.Anchored = false

        local currentTime = tick()
        if currentTime - lastAttackTime >= 0.08 then
            if AutoFarmConfig.AutoClickEnabled then
                attack()
            end
            lastAttackTime = currentTime
        end

        if AutoFarmConfig.AutoSkillEnabled then
            if currentTime - lastSkillTime >= 2 then
                if AutoFarmConfig.Skills.E then fireSkill("E") end
                if AutoFarmConfig.Skills.R then fireSkill("R") end
                if AutoFarmConfig.Skills.T then fireSkill("T") end
                lastSkillTime = currentTime
            end
        end
    end)
end

-- Anti-cheat MacroGui ê°ì§€ ì‹œ ìë™ ì¤‘ë‹¨
task.spawn(function()
    while true do
        task.wait(1)
        pcall(function()
            local gui = LocalPlayer.PlayerGui:FindFirstChild("MacroGui")
            if gui and gui.Enabled then
                print("[ANTI-CHEAT] MacroGui ê°ì§€ â†’ 5ì´ˆ ì˜¤í† íŒœ ì¤‘ë‹¨")
                AutoFarmConfig.Enabled = false
                deathPauseUntil = tick() + 5
                AutoFarmConfig.CurrentTarget = nil
            end
        end)
    end
end)

print("ğŸš€ ëª¨ë“  ê¸°ëŠ¥ ì™„ì „ í†µí•© ì™„ë£Œ | upper ìˆ˜ì§ ê³ ì • + ì£½ìŒ 5ì´ˆ ì¤‘ë‹¨ + ì•ˆí‹°ì¹˜íŠ¸ ìë™ í’€ë¦¼ | F9 ë¡œê·¸ í™•ì¸")
