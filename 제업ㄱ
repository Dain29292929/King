-- ì£½ìœ¼ë©´ 5ì´ˆ ì¤‘ë‹¨ + ë¦¬ìŠ¤í° í›„ ì¬ê°œ | í”ë“¤ë¦¼ ì™„ì „ ë°©ì§€ | Lv10+ ìŠ¬ë¼ì„ ê°•ì œ | ë¨¸ë¦¬ ìœ„ ìˆ˜ì§ ì—ë“œë¦¼ | ì¿¨íƒ€ì„ 0.02ì´ˆ
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local Character, HRP, Hum = nil, nil, nil
local farming = true
local lastSell = 0
local curTarget = nil
local switchTime = 0
local deathPauseUntil = 0  -- ì£½ìœ¼ë©´ ì´ ì‹œê°„ê¹Œì§€ ì¤‘ë‹¨

-- ë¦¬ìŠ¤í° ë°”ì¸ë“œ + ì‚¬ë§ ê°ì§€
local function bindChar(char)
    print("[DEBUG] ìºë¦­í„° ì¬ë°”ì¸ë“œ")
    Character = char
    HRP = char:WaitForChild("HumanoidRootPart", 10)
    Hum = char:WaitForChild("Humanoid", 10)
    if not HRP or not Hum then task.wait(3) bindChar(char) return end
    
    Hum.MaxHealth = math.huge Hum.Health = math.huge
    for _, p in pairs(char:GetDescendants()) do if p:IsA("BasePart") then p.CanCollide = false end end
    Instance.new("ForceField", char)
    
    -- ì‚¬ë§ ê°ì§€ ì—°ê²°
    Hum.Died:Connect(function()
        print("[DEATH] ì‚¬ë§ ê°ì§€ â†’ 5ì´ˆ ì˜¤í† íŒœ ì¤‘ë‹¨")
        farming = false
        deathPauseUntil = tick() + 5
        curTarget = nil
    end)
end

LocalPlayer.CharacterAdded:Connect(function(c) task.wait(0.5) bindChar(c) end)
if LocalPlayer.Character then bindChar(LocalPlayer.Character) end

-- ë ˆë²¨
local function getLevel()
    local ls = LocalPlayer:WaitForChild("leaderstats", 8)
    if not ls then return 0 end
    local lvl = ls:WaitForChild("Level", 5)
    if not lvl then return 0 end
    return lvl.Value or 0
end

-- getQuestNum ì˜¤ë¥˜ ë¬´ì‹œ
local function getQuestNum()
    local success, result = pcall(function()
        local pg = LocalPlayer:WaitForChild("PlayerGui", 10)
        if not pg then return 0 end
        
        local sg = pg:FindFirstChild("ScreenGui") or pg:FindFirstChild("MainGui") or pg:FindFirstChild("UI")
        if not sg then return 0 end
        
        local q = sg:FindFirstChild("Quest") or sg:FindFirstChild("QuestFrame")
        if not q then return 0 end
        
        for _, o in pairs(q:GetDescendants()) do
            if o and (o:IsA("TextLabel") or o:IsA("TextButton")) then
                local t = o.Text or ""
                if t:find("%[2%]") then return 2 end
            end
        end
        return 0
    end)
    
    return success and result or 0
end

-- SellItem
local function trySell()
    if tick() - lastSell < 1.5 then return end
    local r = ReplicatedStorage:FindFirstChild("Remote")
    if not r then return end
    local s = r:FindFirstChild("SellItem")
    if not s then return end
    local args = {"ëŒ ê³¨ë ˜ ë¨¸ë¦¬", "10"}
    pcall(s.FireServer, s, unpack(args))
    lastSell = tick()
end

-- íŠ¹ìˆ˜ ê³ ë¸”ë¦° ìŠ¤í‚µ
local function isSpecial(mob)
    if not mob then return false end
    local la = mob:FindFirstChild("Left Arm") or mob:FindFirstChild("LeftArm")
    if not la then return false end
    local lar = la:FindFirstChild("L Armor") or la:FindFirstChild("LArmor")
    if not lar then return false end
    local m = lar:FindFirstChild("Meshes")
    if not m then return false end
    return m:FindFirstChild("zompg forest mob_Cone") ~= nil
end

-- ìŠ¬ë¼ì„ ì°¾ê¸°
local function findSlime()
    local folder = workspace:FindFirstChild("Mobs")
    if not folder then print("[ERROR] Mobs í´ë” ì—†ìŒ") return nil end
    
    local kids = folder:GetChildren()
    local cands = {}
    
    for _, m in ipairs(kids) do
        if m and m:IsA("Model") and m.Name == "ìŠ¬ë¼ì„" then
            local h = m:FindFirstChild("Humanoid")
            local hrp = m:FindFirstChild("HumanoidRootPart")
            if h and hrp and h.Health > 0 then
                table.insert(cands, m)
            end
        end
    end
    
    print("[DEBUG] ìŠ¬ë¼ì„ í›„ë³´: " .. #cands)
    if #cands == 0 then return nil end
    
    table.sort(cands, function(a,b)
        local aHRP = a:FindFirstChild("HumanoidRootPart")
        local bHRP = b:FindFirstChild("HumanoidRootPart")
        if not aHRP or not bHRP then return false end
        return (HRP.Position - aHRP.Position).Magnitude < (HRP.Position - bHRP.Position).Magnitude
    end)
    
    return cands[1]
end

-- ê³ ë¸”ë¦° ì°¾ê¸°
local function findGoblin()
    local folder = workspace:FindFirstChild("Mobs")
    if not folder then print("[ERROR] Mobs í´ë” ì—†ìŒ") return nil end
    
    local kids = folder:GetChildren()
    local cands = {}
    
    for _, m in ipairs(kids) do
        if m and m:IsA("Model") and (m.Name == "ê³ ë¸”ë¦°" or m.Name:find("ê³ ë¸”ë¦°") or m.Name:lower():find("goblin")) then
            local h = m:FindFirstChild("Humanoid")
            local hrp = m:FindFirstChild("HumanoidRootPart")
            if h and hrp and h.Health > 0 and not isSpecial(m) then
                table.insert(cands, m)
            end
        end
    end
    
    print("[DEBUG] ê³ ë¸”ë¦° í›„ë³´: " .. #cands)
    if #cands == 0 then return nil end
    
    table.sort(cands, function(a,b)
        local aHRP = a:FindFirstChild("HumanoidRootPart")
        local bHRP = b:FindFirstChild("HumanoidRootPart")
        if not aHRP or not bHRP then return false end
        return (HRP.Position - aHRP.Position).Magnitude < (HRP.Position - bHRP.Position).Magnitude
    end)
    
    return cands[1]
end

-- íˆíŠ¸ë°•ìŠ¤ ìë™ ì„ íƒ
local function getBestHitPart(mob)
    if not mob then return HRP end
    for _, name in ipairs({"Head", "UpperTorso", "Torso", "HumanoidRootPart", "LowerTorso"}) do
        local part = mob:FindFirstChild(name)
        if part then return part end
    end
    return mob:FindFirstChild("HumanoidRootPart") or mob
end

-- ê³µê²© (0.055ì´ˆ ì¿¨íƒ€ì„)
local function attack()
    print("[ATTACK] ê³µê²© ì‹œì‘ - 0.055ì´ˆ ì¿¨íƒ€ì„")
    for i = 1, 100 do
        VirtualUser:Button1Down(Vector2.new(500, 500))
        task.wait(0.055 + math.random(-5,5)/1000)  -- 0.05~0.06ì´ˆ
        VirtualUser:Button1Up(Vector2.new(500, 500))
    end
end

-- ë©”ì¸ ë£¨í”„
RunService.Heartbeat:Connect(function()
    if not farming or not HRP then return end
    
    -- ì£½ì€ í›„ 5ì´ˆ ì¤‘ë‹¨ ì²˜ë¦¬
    if tick() < deathPauseUntil then
        farming = false
        return
    else
        farming = true
    end
    
    local lvl = getLevel()
    if lvl >= 15 then farming = false print("Lv15 â†’ ì¢…ë£Œ") return end
    
    local q = getQuestNum()
    if q == 2 then trySell() end
    
    if not curTarget or not curTarget.Parent or (curTarget:FindFirstChildWhichIsA("Humanoid") and curTarget.Humanoid.Health <= 0) then
        if lvl >= 10 then
            curTarget = findSlime()
        else
            curTarget = findGoblin()
        end
        switchTime = tick()
        if curTarget then print("[TARGET] " .. curTarget.Name) end
    end
    
    if not curTarget then task.wait(1) return end
    
    local head = curTarget:FindFirstChild("Head") or curTarget:FindFirstChild("HumanoidRootPart")
    if not head then
        print("[WARNING] Head/HRP nil â†’ ì¬íƒìƒ‰")
        curTarget = nil
        return
    end
    
    local off = Vector3.new(0, 2.3, -0.3) -- ë¨¸ë¦¬ ìœ„ 2.3 + ì•ìœ¼ë¡œ 0.3
    
    local baseCFrame = CFrame.new(head.Position + off, head.Position)
    local tilt = CFrame.Angles(math.rad(-60), 0, 0) -- ì—ë“œë¦¼ ê°ë„
    
    local finalCFrame = baseCFrame * tilt
    
    -- í”ë“¤ë¦¼ ë°©ì§€: Tween ì‹œê°„ ì¤„ì´ê³ , ì¶”ê°€ ê°•ì œ ì„¤ì •
    local tweenInfo = TweenInfo.new(0.05, Enum.EasingStyle.Linear)
    local goal = {CFrame = finalCFrame}
    local tween = TweenService:Create(HRP, tweenInfo, goal)
    tween:Play()
    
    -- Tween ì™„ë£Œ í›„ ì¦‰ì‹œ ì¬ì„¤ì • (í”ë“¤ë¦¼ ì™„ì „ ì œê±°)
    task.delay(0.05, function()
        if HRP and HRP.Parent then
            HRP.CFrame = finalCFrame
        end
    end)
    
    pcall(function() HRP:SetNetworkOwner(LocalPlayer) end)
    HRP.Velocity = Vector3.new(0,0,0)
    HRP.Anchored = true
    task.wait(0.1)
    HRP.Anchored = false
    
    Hum.MaxHealth = math.huge Hum.Health = math.huge
    task.spawn(attack)
end)

print("ğŸš€ ì£½ìœ¼ë©´ 5ì´ˆ ì¤‘ë‹¨ + í”ë“¤ë¦¼ ì™„ì „ ì œê±° ë²„ì „ ì‹¤í–‰ | F9 ë¡œê·¸ í™•ì¸")
